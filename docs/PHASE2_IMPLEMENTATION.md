# Phase 2: ì›¹ì†Œì¼“ ê¸°ë³¸ êµ¬í˜„ ì™„ë£Œ

## âœ… êµ¬í˜„ ì™„ë£Œ ì‚¬í•­

### 1. ì›¹ì†Œì¼“ ì—°ê²° (5ê°œ ìŠ¤íŠ¸ë¦¼)

| ìŠ¤íŠ¸ë¦¼ | êµ¬í˜„ | ìš©ë„ |
|--------|------|------|
| `kline_1m` | âœ… | 1ë¶„ë´‰ ì™„ì„± â†’ ì¶”ë¡  íŠ¸ë¦¬ê±° |
| `kline_15m` | âœ… | 15ë¶„ë´‰ ì™„ì„± â†’ ìºì‹œ ì—…ë°ì´íŠ¸ |
| `kline_1h` | âœ… | 1ì‹œê°„ë´‰ ì™„ì„± â†’ ìºì‹œ ì—…ë°ì´íŠ¸ |
| `markPrice@1s` | âœ… | SL/TP ëª¨ë‹ˆí„°ë§, PnL ê³„ì‚° |
| `bookTicker` | âœ… | ìŠ¬ë¦¬í”¼ì§€ ê³„ì‚°ìš© í˜¸ê°€ |

**ìŠ¤íŠ¸ë¦¼ ìˆ˜**: 30ì¢…ëª© Ã— 5ìŠ¤íŠ¸ë¦¼ = **150ê°œ**
**ì—°ê²° ìˆ˜**: **1ê°œ** (limit: 200 ìŠ¤íŠ¸ë¦¼)

### 2. íŒŒì¼ êµ¬ì¡°

```
services/
â”œâ”€â”€ websocket/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ connection.py              # ì—°ê²° ê´€ë¦¬ + ì¬ì—°ê²°
â”‚   â”œâ”€â”€ stream_router.py           # ë©”ì‹œì§€ ë¼ìš°íŒ…
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ kline_handler.py       # ìº”ë“¤ ì²˜ë¦¬ + ì¶”ë¡  íŠ¸ë¦¬ê±°
â”‚       â”œâ”€â”€ mark_price_handler.py  # SL/TP ëª¨ë‹ˆí„°ë§
â”‚       â””â”€â”€ book_ticker_handler.py # í˜¸ê°€ ì²˜ë¦¬
â”‚
â”œâ”€â”€ collector/
â”‚   â””â”€â”€ buffer.py                  # (ìˆ˜ì •) 15m, 1h ìº”ë“¤ ë²„í¼ ì¶”ê°€
â”‚
â””â”€â”€ realtime_worker_ws.py          # ìƒˆ ì›¹ì†Œì¼“ ì›Œì»¤
```

### 3. ì—°ê²° ê´€ë¦¬ (connection.py)

**íŠ¹ì§•:**
- ì—°ê²°ë‹¹ **200 ìŠ¤íŠ¸ë¦¼ ì œí•œ** (ë°”ì´ë‚¸ìŠ¤ 1024 ì¤‘ ì—¬ìœ ë¶„)
- ì¬ì—°ê²° ë¡œì§: **ì§€ìˆ˜ ë°±ì˜¤í”„** (1s â†’ 2s â†’ 4s â†’ ... â†’ 60s)
- ì—°ê²° ì„±ê³µ ì‹œ ì¬ì‹œë„ ì¹´ìš´í„° ë¦¬ì…‹
- Ping/Pong: 3ë¶„ë§ˆë‹¤ (ë°”ì´ë‚¸ìŠ¤ ìš”êµ¬ì‚¬í•­)

```python
# ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì—°ê²°
retry_delay = min(2 ** reconnect_count, 60)
```

### 4. ë©”ì‹œì§€ ë¼ìš°íŒ… (stream_router.py)

**ê¸°ëŠ¥:**
- ìŠ¤íŠ¸ë¦¼ íƒ€ì…ë³„ í•¸ë“¤ëŸ¬ ë“±ë¡
- ë©”ì‹œì§€ í†µê³„ ì¶”ì  (total, routed, unhandled)
- ì—ëŸ¬ í•¸ë“¤ë§

**ë“±ë¡ëœ í•¸ë“¤ëŸ¬:**
- `kline_1m` â†’ KlineHandler.handle_kline_1m
- `kline_15m` â†’ KlineHandler.handle_kline_15m
- `kline_1h` â†’ KlineHandler.handle_kline_1h
- `markPrice@1s` â†’ MarkPriceHandler.handle
- `bookTicker` â†’ BookTickerHandler.handle

### 5. ìº”ë“¤ ì²˜ë¦¬ (kline_handler.py)

**1m ìº”ë“¤:**
- ë´‰ ì™„ì„±(`is_closed=true`) ì²´í¬
- ì¤‘ë³µ ë°©ì§€ (ê°™ì€ close_time ë¬´ì‹œ)
- DB ë²„í¼ì— ì €ì¥
- **ì¶”ë¡  íŠ¸ë¦¬ê±°** (`on_1m_candle_close` ì½œë°±)

**15m/1h ìº”ë“¤:**
- ë´‰ ì™„ì„± ì‹œ ë²„í¼ì— ì €ì¥ë§Œ
- ì¶”ë¡  íŠ¸ë¦¬ê±° ì—†ìŒ

### 6. ë§ˆí¬ê°€ê²© ì²˜ë¦¬ (mark_price_handler.py)

**ê¸°ëŠ¥:**
- ë§ˆí¬ê°€ê²©, ì¸ë±ìŠ¤ê°€ê²©, í€ë”©ìœ¨ ìºì‹±
- SL/TP ëª¨ë‹ˆí„°ë§ìš© (TODO)
- 1ë¶„ë§ˆë‹¤ `premium_index` í…Œì´ë¸”ì— ì €ì¥

**ìºì‹œ êµ¬ì¡°:**
```python
{
  "BTCUSDT": {
    "mark_price": 36050.0,
    "index_price": 36045.0,
    "funding_rate": 0.0001,
    "next_funding_time": datetime(...),
    "updated_at": datetime(...)
  }
}
```

### 7. í˜¸ê°€ ì²˜ë¦¬ (book_ticker_handler.py)

**ê¸°ëŠ¥:**
- ìµœìš°ì„  í˜¸ê°€ ìºì‹± (bid, ask)
- ìŠ¤í”„ë ˆë“œ ê³„ì‚° (bps)
- ìŠ¬ë¦¬í”¼ì§€ ì¶”ì • í•¨ìˆ˜ ì œê³µ

**ìºì‹œ êµ¬ì¡°:**
```python
{
  "BTCUSDT": {
    "bid": 36049.0,
    "bid_qty": 10.5,
    "ask": 36050.0,
    "ask_qty": 8.2,
    "spread": 1.0,
    "spread_bps": 0.28,
    "updated_at": datetime(...)
  }
}
```

### 8. REST API í´ë§ (realtime_worker_ws.py)

| ë°ì´í„° | í´ë§ ì£¼ê¸° | êµ¬í˜„ |
|--------|----------|------|
| Open Interest | **1ë¶„** | âœ… |
| L/S Ratio | **5ë¶„** | âœ… |
| Top L/S Ratio | **5ë¶„** | âœ… |
| Taker Buy/Sell | **5ë¶„** | âœ… |

**ë¡œì§:**
- 60ì´ˆë§ˆë‹¤ ë£¨í”„ ì‹¤í–‰
- OIëŠ” ë§¤ë²ˆ ìˆ˜ì§‘
- L/S ë¹„ìœ¨ì€ 5ë¶„(300ì´ˆ) ê²½ê³¼ ì‹œì—ë§Œ ìˆ˜ì§‘

### 9. ë²„í¼ ê´€ë¦¬

**ë²„í¼ ì¢…ë¥˜:**
- `candles` (1m) - ê¸°ì¡´
- `candles_15m` - ì‹ ê·œ
- `candles_1h` - ì‹ ê·œ
- `premium` - ê¸°ì¡´ (markPrice ë°ì´í„° ì§‘ê³„)
- `open_interest` - ê¸°ì¡´
- `long_short_ratio` - ê¸°ì¡´

**í”ŒëŸ¬ì‹œ:**
- ë°°ì¹˜ í¬ê¸° ë˜ëŠ” ì‹œê°„ ì£¼ê¸° ë„ë‹¬ ì‹œ
- ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ë¡œ 5ì´ˆë§ˆë‹¤ ì²´í¬

### 10. ì¶”ë¡  íŠ¸ë¦¬ê±°

**íë¦„:**
```
1m ìº”ë“¤ ì™„ì„± (is_closed=true)
   â†“
DB ì €ì¥ (candles_1m)
   â†“
on_1m_candle_close(symbol, close_time)
   â†“
run_inference(symbol) [ë¹„ë™ê¸°]
   â†“
í”¼ì²˜ ê³„ì‚° â†’ ì¶”ë¡  â†’ ì‹œê·¸ë„ ì €ì¥ â†’ Redis ë°œí–‰
```

**í•µì‹¬:**
- **1m ë´‰ ì™„ì„± ì‹œì—ë§Œ** ì¶”ë¡ 
- 15m/1hëŠ” ìºì‹œë§Œ ì—…ë°ì´íŠ¸
- ë¹„ë™ê¸° ì‹¤í–‰ìœ¼ë¡œ ì›¹ì†Œì¼“ ë¸”ë¡œí‚¹ ë°©ì§€

---

## ğŸ”§ ì„¤ì • ì¶”ê°€

**packages/common/config.py:**
```python
binance_futures_ws_url: str = "wss://fstream.binance.com"
# Testnet: wss://stream.binancefuture.com
```

---

## ğŸ“Š ë°ì´í„° í”Œë¡œìš°

### ì›¹ì†Œì¼“ â†’ DB
1. **kline_1m** â†’ `candles_1m` (ë´‰ ì™„ì„± ì‹œ)
2. **kline_15m** â†’ `candles_15m` (ë´‰ ì™„ì„± ì‹œ)
3. **kline_1h** â†’ `candles_1h` (ë´‰ ì™„ì„± ì‹œ)
4. **markPrice@1s** â†’ `premium_index` (1ë¶„ ì§‘ê³„)

### REST â†’ DB
1. **Open Interest** â†’ `open_interest` (1ë¶„)
2. **L/S Ratios** â†’ `long_short_ratio` (5ë¶„)

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ê¸°ì¡´ ì›Œì»¤ (REST í´ë§)
```bash
python -m services.realtime_worker
```

### ìƒˆ ì›Œì»¤ (ì›¹ì†Œì¼“)
```bash
python -m services.realtime_worker_ws
```

---

## âš ï¸ ì•Œë ¤ì§„ ì œì•½ì‚¬í•­

1. **userData ìŠ¤íŠ¸ë¦¼ ë¯¸êµ¬í˜„**
   - Phase 8ì—ì„œ êµ¬í˜„ ì˜ˆì •
   - ì‹¤ê±°ë˜ ì‹œ ì£¼ë¬¸/í¬ì§€ì…˜ ë™ê¸°í™”ìš©

2. **ëˆ„ë½ ë°ì´í„° ë°±í•„ ì—†ìŒ**
   - ì—°ê²° ëŠê¹€ ì‹œ ëˆ„ë½ ë°ì´í„°ëŠ” ë¡œê·¸ë§Œ
   - ì¬í•™ìŠµ ë•Œ ì²˜ë¦¬ (ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­)

3. **SL/TP ìë™ ì²­ì‚° ë¯¸êµ¬í˜„**
   - markPrice í•¸ë“¤ëŸ¬ì— TODOë¡œ ë‚¨ê¹€
   - Phase 5 ì´í›„ êµ¬í˜„ ì˜ˆì •

4. **ê±°ë˜ ëª¨ë“œ ìˆ˜ë™ ì œì–´ ë¯¸êµ¬í˜„**
   - Phase 3ì—ì„œ êµ¬í˜„ ì˜ˆì •
   - í˜„ì¬ëŠ” í•­ìƒ ì¶”ë¡  ì‹¤í–‰

---

## ğŸ“ˆ ì„±ëŠ¥ ê°œì„ 

| í•­ëª© | ê¸°ì¡´ (REST) | ê°œì„  (WS) |
|------|-------------|-----------|
| ì§€ì—° | ìµœëŒ€ 5ì´ˆ | < 100ms |
| ì¶”ë¡ /ë¶„ | 12íšŒ (ì¤‘ë³µ) | 1íšŒ (ì •í™•) |
| API í˜¸ì¶œ/ë¶„ | ~360íšŒ | ~36íšŒ |

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] 5ê°œ ìŠ¤íŠ¸ë¦¼ ëª¨ë‘ êµ¬ë…
- [x] ì¬ì—°ê²° ë¡œì§ (ì§€ìˆ˜ ë°±ì˜¤í”„)
- [x] 1m ë´‰ ì™„ì„± ì‹œ ì¶”ë¡  íŠ¸ë¦¬ê±°
- [x] 15m/1h ìºì‹œ ì—…ë°ì´íŠ¸
- [x] markPrice ë°ì´í„° ì €ì¥
- [x] bookTicker í˜¸ê°€ ìºì‹±
- [x] REST í´ë§ (OI: 1ë¶„, L/S: 5ë¶„)
- [x] ë²„í¼ í”ŒëŸ¬ì‹œ ìë™í™”
- [x] í†µê³„ ë° ë¡œê¹…
- [ ] userData ìŠ¤íŠ¸ë¦¼ (Phase 8)
- [ ] SL/TP ìë™ ì²­ì‚° (Phase 5)
- [ ] ê±°ë˜ ëª¨ë“œ ìˆ˜ë™ ì œì–´ (Phase 3)

---

*ìµœì¢… ì—…ë°ì´íŠ¸: 2026-02-04*
